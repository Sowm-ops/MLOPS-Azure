name: Azure MLOps Pipeline (Train + DVC + Tests)

permissions:
  contents: write

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "params.yaml"
      - "dvc.yaml"
      - "dvc.lock"
      - "data/**"
      - "models/**"
      - "metrics/**"
      - "tests/**"
      - ".github/workflows/ci.yml"

jobs:
  mlops:
    runs-on: ubuntu-latest

    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      AZURE_CONTAINER: dvcstore

    steps:
    # ----------------------
    # CHECKOUT
    # ----------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ----------------------
    # PYTHON
    # ----------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install dvc[azure] pytest evidently==0.4.32

    # ----------------------
    # CONFIGURE DVC REMOTE (AZURE)
    # ----------------------
    - name: Configure DVC Remote
      run: |
        dvc remote modify azure connection_string "${AZURE_STORAGE_CONNECTION_STRING}"

    # ----------------------
    # FETCH DATA/MODELS
    # ----------------------
    - name: DVC Pull (Azure)
      run: dvc pull -v --force || echo "No remote data yet"

    # ----------------------
    # DOWNLOAD NLTK
    # ----------------------
    - name: Download NLTK Data
      run: |
        python - <<EOF
        import nltk
        nltk.download('punkt')
        nltk.download('punkt_tab')
        nltk.download('stopwords')
        nltk.download('wordnet')
        nltk.download('omw-1.4')
        EOF

    # ----------------------
    # TEST SUITE
    # ----------------------
    - name: Run PyTest
      run: |
        echo "Running pytest test suite..."
        pytest -q

    - name: Stop if tests fail
      if: failure()
      run: exit 1

    # ----------------------
    # RUN PIPELINE
    # ----------------------
    - name: Run Data Preparation
      run: python src/data_prep.py

    - name: Train Models
      run: python src/train.py

    - name: DVC Repro
      run: dvc repro

    - name: Push to Azure Blob
      run: dvc push -v

    # ----------------------
    # COMMIT METADATA
    # ----------------------
    - name: Commit updated DVC + metrics
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add . || true
        git commit -m "Auto-update: Azure MLOps pipeline outputs" || true
        git push

    # ---------------------
    # UPLOAD METRICS
    # ----------------------
    - name: Upload metrics artifact
      uses: actions/upload-artifact@v4
      with:
        name: metrics
        path: metrics/
