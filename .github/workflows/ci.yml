name: Full Azure MLOps Pipeline (Train + Build + Deploy)

permissions:
  contents: write
  id-token: write

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "serve.py"
      - "Dockerfile"
      - "requirements.txt"
      - "params.yaml"
      - "dvc.yaml"
      - "dvc.lock"
      - "models/**"
      - "data/**"
      - "metrics/**"
      - "tests/**"
      - ".github/workflows/ci.yml"

jobs:

  #######################################################
  #  TRAINING JOB (DVC + Tests + Train + Push)
  #######################################################
  train:
    runs-on: ubuntu-latest

    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      AZURE_CONTAINER: dvcstore

    steps:

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Add project root to PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install dvc[azure] pytest evidently==0.4.32

    - name: Configure DVC Remote
      run: dvc remote modify azure connection_string "${AZURE_STORAGE_CONNECTION_STRING}"

    - name: DVC Pull
      run: dvc pull -v --force || echo "No cache yet."

    - name: Download NLTK Data
      run: |
        python - <<EOF
        import nltk
        nltk.download('punkt')
        nltk.download('punkt_tab')
        nltk.download('stopwords')
        nltk.download('wordnet')
        nltk.download('omw-1.4')
        EOF

    - name: Run PyTest
      run: pytest -q

    - name: Stop if tests fail
      if: failure()
      run: exit 1

    - name: Run Training Pipeline
      run: |
        python src/data_prep.py
        python src/train.py
        dvc repro

    - name: Push updated artifacts
      run: dvc push -v

    - name: Commit updated pipeline files
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add .
        git commit -m "Auto update: training + dvc artifacts" || echo "No changes"
        git push

  ########################################################
  #  BUILD DOCKER IMAGE AND PUSH TO ACR
  ########################################################
  build:
    needs: train
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Azure CLI - Login to ACR
      run: |
        az acr login --name ${{ secrets.AZURE_REGISTRY_NAME }}

    - name: Build and Push Docker Image
      run: |
        IMAGE_NAME=${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/mlops-api:v${{ github.run_number }}
        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        docker build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

  ########################################################
  #  DEPLOY NEW IMAGE TO AZURE CONTAINER APPS
  ########################################################
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ secrets.AZURE_CONTAINER_APP }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --image ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/mlops-api:v${{ github.run_number }}
