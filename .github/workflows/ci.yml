name: Full Azure MLOps Pipeline (Train + Build + Deploy)

permissions:
  contents: write
  id-token: write

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "serve.py"
      - "Dockerfile"
      - "requirements.txt"
      - "params.yaml"
      - "dvc.yaml"
      - "dvc.lock"
      - "models/**"
      - "data/**"
      - "metrics/**"
      - "tests/**"
      - ".github/workflows/ci.yml"

jobs:

  #######################################################
  #  TRAINING JOB (DVC + Tests + Train + Push)
  #######################################################
  train:
    runs-on: ubuntu-latest

    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
      AZURE_CONTAINER: dvcstore

    steps:

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
    
    - name: Add project root to PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)" >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install dvc[azure] pytest evidently==0.4.32

    - name: Configure DVC Remote
      run: |
        dvc remote modify --local azure connection_string "${AZURE_STORAGE_CONNECTION_STRING}"
        dvc config core.remote azure

    - name: DVC Pull
      run: dvc pull -r azure --force -v || echo "No cache yet."

    - name: Download NLTK Data
      run: |
        python - <<EOF
        import nltk
        nltk.download('punkt')
        nltk.download('punkt_tab')
        nltk.download('stopwords')
        nltk.download('wordnet')
        nltk.download('omw-1.4')
        EOF

    - name: Run Pre-Training Tests
      run: pytest tests/pre -q

    - name: Run Training Pipeline
      run: |
        python src/data_prep.py
        python src/train.py
        dvc repro

    - name: Run Post-Training Tests
      run: pytest tests/post -q

    - name: Push updated artifacts
      run: dvc push -r azure -v

    - name: Commit updated pipeline files
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        git add dvc.lock metrics/
        git commit -m "Auto update: training + dvc artifacts" || echo "No changes"
        git push

  ########################################################
  #  BUILD DOCKER IMAGE (PULL MODELS FROM DVC)
  ########################################################
  build:
    needs: train
    runs-on: ubuntu-latest

    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install DVC
      run: pip install dvc[azure]

    - name: Configure DVC Remote
      run: |
        dvc remote modify --local azure connection_string "${AZURE_STORAGE_CONNECTION_STRING}"
        dvc config core.remote azure


    - name: DVC Pull Models
      run: dvc pull -r azure --force -v

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: az acr login --name ${{ secrets.AZURE_REGISTRY_NAME }}

    - name: Build and Push Docker Image
      run: |
        IMAGE_NAME=${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/mlops-api:gha-${{ github.run_number }}
        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        docker build -t $IMAGE_NAME .
        docker push $IMAGE_NAME

  ########################################################
  #  DEPLOY TO AZURE CONTAINER APPS
  ########################################################
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ secrets.AZURE_CONTAINER_APP }} \
          --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          --image ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/mlops-api:gha-${{ github.run_number }}